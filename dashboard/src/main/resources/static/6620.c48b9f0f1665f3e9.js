"use strict";var Nn=Object.defineProperty,Gn=Object.defineProperties,Wn=Object.getOwnPropertyDescriptors,ti=Object.getOwnPropertySymbols,jn=Object.prototype.hasOwnProperty,$n=Object.prototype.propertyIsEnumerable,ce=Math.pow,ii=($,B,c)=>B in $?Nn($,B,{enumerable:!0,configurable:!0,writable:!0,value:c}):$[B]=c,N=($,B)=>{for(var c in B||(B={}))jn.call(B,c)&&ii($,c,B[c]);if(ti)for(var c of ti(B))$n.call(B,c)&&ii($,c,B[c]);return $},me=($,B)=>Gn($,Wn(B));(self.webpackChunkdashboard=self.webpackChunkdashboard||[]).push([[6620],{36620:($,B,c)=>{c.r(B),c.d(B,{GraphicContainer:()=>Sn.Z,GraphicsView2D:()=>Tn.Z,LabelManager:()=>Mn,MagnifierView2D:()=>Hn,MapViewNavigation:()=>Un,Stage:()=>tn});var y=c(61921),F=c(22795),si=c(99676),Se=c(67474),v=c(60305),ni=c(61993),lt=c(97467),ri=c(65566),Ve=c(97209),ai=c(86934),ht=c(61274),D=c(87492),K=c(64298),pe=c(26436),ee=c(27001),Z=(c(36320),c(40150),c(94345),c(91522)),oi=c(88924),Y=c(13006),Pe=c(48082),li=c(3289),dt=c(29729),I=c(963);function Ze(n){if(!n)return null;const e=n.inverseTransform,t=n.transform,i=n.transformNoRotation,r=n.pixelRatio,a=[n.size[0],n.size[1]],o=n.viewpoint.targetGeometry,l=(0,K.f)(o.x,o.y);return{version:n.id,displayMat3:n.displayMat3.slice(),displayViewMat3:n.displayViewMat3.slice(),viewMat2d:n.viewMat2d.slice(),extent:n.extent.toJSON(),resolution:n.resolution,rotation:n.rotation,size:a,scale:n.scale,center:[o.x,o.y],spatialReference:n.spatialReference,pixelRatio:r,viewpoint:n.viewpoint,worldScreenWidth:n.worldScreenWidth,toMap:(h,d)=>(0,D.t)(h,d,e),toScreen:(h,d)=>(0,D.t)(h,d,t),toScreenNoRotation:(h,d)=>(0,D.t)(h,d,i),getScreenTransform:(h,d)=>((0,I.Rb)(h,l,a,d,0,r),h)}}var R=c(38963),hi=c(81530),ne=(c(82705),c(56109)),ut=c(25558),di=c(42789),ui={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = mod(v_accumulatedDistance / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = mod((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * v_lineHalfWidth;\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};const mi=new di.Z(function(n){let e=ui;return n.split("/").forEach(t=>{e&&(e=e[t])}),e});function U(n){return mi.resolveIncludes(n)}const ct=n=>(0,Z.K)({ID:n.id,PATTERN:n.pattern}),pi={shaders:n=>({vertexShader:ct(n)+U("background/background.vert"),fragmentShader:ct(n)+U("background/background.frag")})},mt=n=>(0,Z.K)({ID:n.id}),gi={shaders:n=>({vertexShader:mt(n)+U("circle/circle.vert"),fragmentShader:mt(n)+U("circle/circle.frag")})},pt=n=>(0,Z.K)({ID:n.id,PATTERN:n.pattern}),fi={shaders:n=>({vertexShader:pt(n)+U("fill/fill.vert"),fragmentShader:pt(n)+U("fill/fill.frag")})},gt=n=>(0,Z.K)({ID:n.id}),_i={shaders:n=>({vertexShader:gt(n)+U("outline/outline.vert"),fragmentShader:gt(n)+U("outline/outline.frag")})},ft=n=>(0,Z.K)({ID:n.id,SDF:n.sdf}),vi={shaders:n=>({vertexShader:ft(n)+U("icon/icon.vert"),fragmentShader:ft(n)+U("icon/icon.frag")})},_t=n=>(0,Z.K)({ID:n.id,PATTERN:n.pattern,SDF:n.sdf}),yi={shaders:n=>({vertexShader:_t(n)+U("line/line.vert"),fragmentShader:_t(n)+U("line/line.frag")})},vt=n=>(0,Z.K)({ID:n.id}),bi={shaders:n=>({vertexShader:vt(n)+U("text/text.vert"),fragmentShader:vt(n)+U("text/text.frag")})};class wi{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,t,i){const r=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(r))return this._programByKey.get(r);const a=this._getProgramTemplate(t.type),{shaders:o}=a,{vertexShader:l,fragmentShader:h}=o(i),d=t.getShaderHeader(),p=t.getShaderMain(),u=l.replace("#pragma header",d).replace("#pragma main",p),m=new ut.$(e,u,h,t.getAttributeLocations());return this._programByKey.set(r,m),m}_getMaterialOptionsValue(e,t){switch(e){case 0:case 1:return(t.pattern?1:0)<<1|(t.id?1:0);case 2:case 5:case 6:return t.id?1:0;case 3:return(t.sdf?1:0)<<2|(t.pattern?1:0)<<1|(t.id?1:0);case 4:return(t.sdf?1:0)<<1|(t.id?1:0);default:return 0}}_getProgramTemplate(e){switch(e){case 0:return pi;case 5:return gi;case 1:return fi;case 4:return vi;case 3:return yi;case 2:return _i;case 6:return bi;default:return null}}}var A=c(61457);const yt={shaders:{vertexShader:(0,A.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,A.w)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class bt{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(e,t,i,r){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(1,771,1,771),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),e.drawArrays(5,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=yt.attributes,i=(0,Z.H)(e,yt);if(!i)return!1;const a=new Int8Array(16);a[0]=-1,a[1]=-1,a[2]=0,a[3]=0,a[4]=1,a[5]=-1,a[6]=1,a[7]=0,a[8]=-1,a[9]=1,a[10]=0,a[11]=1,a[12]=1,a[13]=1,a[14]=1,a[15]=1;const o=new Pe.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:pe.Z.createVertex(e,35044,a)});return this._program=i,this._vertexArrayObject=o,this._initialized=!0,!0}}var wt=c(13455);const xi=n=>{let e="";e+=n[0].toUpperCase();for(let t=1;t<n.length;t++){const i=n[t];i===i.toUpperCase()?(e+="_",e+=i):e+=i.toUpperCase()}return e},xt=n=>{const e={};for(const t in n)e[xi(t)]=n[t];return(0,Z.K)(e)},Ct=(n,e,t)=>{const i=n+n.substring(n.lastIndexOf("/")),r=e+e.substring(e.lastIndexOf("/"));return{attributes:t,shaders:a=>({vertexShader:xt(a)+(0,A.w)(`${i}.vert`),fragmentShader:xt(a)+(0,A.w)(`${r}.frag`)})}},Mt=n=>n===R.jx.HITTEST||n===R.jx.LABEL_ALPHA;class Si{constructor(e){this._programByKey=new Map,this._programCache=new wt.Z(e)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(e,t,i=[],r=[]){const a=t.vsPath+"."+t.fsPath+JSON.stringify(i)+r.join(".");if(this._programByKey.has(a))return this._programByKey.get(a);const o=r.reduce((m,g)=>me(N({},m),{[g]:e.driverTestResult[g]}),{}),l=N(N({},i.map(m=>"string"==typeof m?{name:m,value:!0}:m).reduce((m,g)=>me(N({},m),{[g.name]:g.value}),{})),o),{vsPath:h,fsPath:d,attributes:p}=t,u=this._programCache.getProgram(Ct(h,d,p),l);if(!u)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,u),u}getMaterialProgram(e,t,i,r,a,o=["ignoresSamplerPrecision"]){const l=(({rendererInfo:n,drawPhase:e},t,i,r)=>`${t.getVariationHash()}-${r.join(".")}-${(n=>(Mt(n)?1:0)|(n===R.jx.HIGHLIGHT?2:0))(e)}-${n.getVariationHash()}-${(0,v.pC)(i)&&i.join(".")}`)(e,t,a,o);if(this._programByKey.has(l))return this._programByKey.get(l);const h=((n,e,t,i)=>{const r=i.reduce((o,l)=>me(N({},o),{[l]:n.driverTestResult[l]}),{}),a=N(me(N(N({},e.getVariation()),n.rendererInfo.getVariation()),{highlight:n.drawPhase===R.jx.HIGHLIGHT,id:Mt(n.drawPhase)}),r);if((0,v.pC)(t))for(const o of t)a[o]=!0;return a})(e,t,a,o),d=this._programCache.getProgram(Ct(i,i,r),h);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(l,d),d}}var Pi=c(4380),ge=c(40662),fe=c(33870),z=c(12523),re=c(12788),Fi=c(3878),Ri=c(72459),T=c(99155),G=c(36392);class Fe{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new G.Z(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new G.Z;let i=null,r=-1;for(let a=0;a<this._free.length;++a){const o=this._free[a];e<=o.width&&t<=o.height&&(null===i||o.y<=i.y&&o.x<=i.x)&&(i=o,r=a)}return null===i?new G.Z:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new G.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new G.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new G.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new G.Z(i.x,i.y+t,e,i.height-t))),new G.Z(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}const Ai=n=>Math.floor(n/256);class ki{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new Fe(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let r=0;r<e.length;r++){const a=e[r];for(let o=0;o<11;o++)t.push(a)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}getGlyphItems(e,t,i){var r=this;return(0,y.Z)(function*(){const a=r._getGlyphCache(e);return yield r._fetchRanges(e,t,i),t.map(o=>r._getMosaicItem(a,e,o))})()}bind(e,t,i,r){const a=this._getTexture(e,i);a.setSamplingMode(t),this._dirties[i]&&(a.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(a,r)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new Y.Z(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,t,i){var r=this;return(0,y.Z)(function*(){const a=function(n){const e=new Set;for(const t of n)e.add(Ai(t));return e}(t),o=[];a.forEach(l=>{o.push(r._fetchRange(e,l,i))}),yield Promise.all(o)})()}_fetchRange(e,t,i){var r=this;return(0,y.Z)(function*(){return t>256?null:function(n,e,t){return n.has(e)||n.set(e,t().then(()=>{n.delete(e)}).catch(i=>{n.delete(e),(0,z.H9)(i)})),n.get(e)}(r._rangePromises,e+t,()=>r._glyphSource.getRange(e,t,i))})()}_getMosaicItem(e,t,i){if(!e[i]){const r=this._glyphSource.getGlyph(t,i);if(!r||!r.metrics)return n=i,{rect:new G.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:n,sdf:!0};const a=this._recordGlyph(r);e[i]={rect:a,page:this._currentPage,metrics:r.metrics,code:i,sdf:!0},this._invalidate()}var n;return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(0===t.width)i=new G.Z(0,0,0,0);else{const r=3,a=t.width+2*r,o=t.height+2*r;i=this._binPack.allocate(a,o),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new Fe(this.width-4,this.height-4),i=this._binPack.allocate(a,o));const l=this._glyphData[this._currentPage],h=e.bitmap;let d,p;if(h)for(let u=0;u<o;u++){d=a*u,p=this.width*(i.y+u)+i.x;for(let m=0;m<a;m++)l[p+m]=h[d+m]}(0,Se.Z)("esri-glyph-debug")&&this._showDebugPage(l)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),r=new ImageData(this.width,this.height),a=r.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let o=0;o<e.length;++o)a[4*o+0]=e[o],a[4*o+1]=0,a[4*o+2]=0,a[4*o+3]=255;i.putImageData(r,0,0),document.body.appendChild(t)}}var Hi=c(88215);class Ni{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const i=t.getMessage();let r,a,o,l,h,d,p;for(;i.next();)switch(i.tag()){case 1:r=i.getUInt32();break;case 2:a=i.getBytes();break;case 3:o=i.getUInt32();break;case 4:l=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:d=i.getSInt32();break;case 7:p=i.getUInt32();break;default:i.skip()}i.release(),r&&(this._metrics[r]={width:o,height:l,left:h,top:d,advance:p},this._bitmaps[r]=a);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class Gi{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class Wi{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const r=this._getFontStack(e);if(r.getRange(t))return Promise.resolve();const a=256*t,o=a+255,l=this._baseURL.replace("{fontstack}",e).replace("{range}",a+"-"+o);return(0,ge.default)(l,N({responseType:"array-buffer"},i)).then(h=>{r.addRange(t,new Ni(new Hi.Z(new Uint8Array(h.data),new DataView(h.data))))})}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const r=Math.floor(t/256);if(r>256)return;const a=i.getRange(r);return a?{metrics:a.getMetrics(t),bitmap:a.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Gi),t}}const ji=[1,256,65536,16777216],$i=[1/256,1/65536,1/16777216,1/4294967296],Ki=function(n,e=0){let t=0;for(let i=0;i<4;i++)t+=n[e+i]*$i[i];return t}(new Uint8ClampedArray([255,255,255,255]));function Yi(n,e,t=0){const i=function(n,e,t){return n<0?0:n>t?t:n}(n,0,Ki);for(let r=0;r<4;r++)e[t+r]=Math.floor(256*Ji(i*ji[r]))}function Ji(n){return n-Math.floor(n)}const _e=1e20;class qi{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const r=this._createSVGString(e);return new Promise((a,o)=>{const l=new Image;l.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(r),l.onload=()=>{l.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(l,0,0,this.size,this.size);const d=this._context.getImageData(0,0,this.size,this.size),p=new Uint8Array(this.size*this.size*4);for(let u=0;u<this.size*this.size;u++){const m=d.data[4*u+3]/255;this._gridOuter[u]=1===m?0:0===m?_e:ce(Math.max(0,.5-m),2),this._gridInner[u]=1===m?_e:0===m?0:ce(Math.max(0,m-.5),2)}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let u=0;u<this.size*this.size;u++)Yi(.5-(this._gridOuter[u]-this._gridInner[u])/(2*i),p,4*u);a(p)};const h=t&&t.signal;h&&(0,z.fu)(h,()=>o((0,z.zE)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}_createSVGString(e){const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),r=i.width/i.height,a=this.size/2;let o,l,h,d;r>1?(l=o=a/i.width,h=this.size/4,d=a-a*(1/r)/2):(o=l=a/i.height,h=a-a*r/2,d=this.size/4),t.setAttribute("style",`transform: matrix(${o}, 0, 0, ${l}, ${-i.x*o+h}, ${-i.y*l+d})`);const m=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),m}_edt(e,t,i){const r=this._f,a=this._d,o=this._v,l=this._z;for(let h=0;h<t;h++){for(let d=0;d<i;d++)r[d]=e[d*t+h];this._edt1d(r,a,o,l,i);for(let d=0;d<i;d++)e[d*t+h]=a[d]}for(let h=0;h<i;h++){for(let d=0;d<t;d++)r[d]=e[h*t+d];this._edt1d(r,a,o,l,t);for(let d=0;d<t;d++)e[h*t+d]=Math.sqrt(a[d])}}_edt1d(e,t,i,r,a){i[0]=0,r[0]=-_e,r[1]=+_e;for(let o=1,l=0;o<a;o++){let h=(e[o]+o*o-(e[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);for(;h<=r[l];)l--,h=(e[o]+o*o-(e[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);l++,i[l]=o,r[l]=h,r[l+1]=+_e}for(let o=0,l=0;o<a;o++){for(;r[l+1]<o;)l++;t[o]=(o-i[l])*(o-i[l])+e[i[l]]}}}var Tt=c(42367);function te(n){return n&&"static"===n.type}class ke{constructor(e,t,i,r=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,this._requestRender=e,r>0&&(this._maxItemSize=r),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Fe(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),o=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*o)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,r,a,o){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let l,h,d;if(te(i)?[l,h,d]=this._allocateImage(t[0],t[1]):(l=new G.Z(0,0,t[0],t[1]),h=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:t,dirty:!0,texture:void 0})),l.width<=0||l.height<=0)return null;const p={rect:l,width:t[0],height:t[1],sdf:a,simplePattern:o,pixelRatio:1,page:h};return this._mosaicRects.set(e,p),te(i)&&this._copy({rect:l,spriteSize:t,spriteData:i.data,page:h,pageSize:d,repeat:r,sdf:a}),p}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const o=T.fL,l=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+o)/l[0],(i.y+o)/l[1]],br:[(i.x+o+t.width)/l[0],(i.y+o+t.height)/l[1]],page:t.page}}bind(e,t,i=0,r=0){const a=this._mosaicPages[i],o=a.mosaicsData;let l=a.texture;if(l||(l=function(n,e,t){return te(e)?new Y.Z(n,{pixelFormat:6408,dataType:5121,width:t[0],height:t[1]},new Uint8Array(e.data.buffer)):new Y.Z(n,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:t[0],height:t[1]},null)}(e,o,a.size),a.texture=l),l.setSamplingMode(t),te(o))e.bindTexture(l,r),a.dirty&&(l.setData(new Uint8Array(o.data.buffer)),l.generateMipmap());else{const h=o.data,d=h.bindFrame(e,l,r);(0,v.pC)(this._requestRender)&&d&&h.frameCount>0&&this._requestRender.requestRender(),h.bindFrame(e,l,r)}a.dirty=!1}static _copyBits(e,t,i,r,a,o,l,h,d,p,u){let m=r*t+i,g=h*o+l;if(u){g-=o;for(let f=-1;f<=p;f++,m=((f+p)%p+r)*t+i,g+=o)for(let _=-1;_<=d;_++)a[g+_]=e[m+(_+d)%d]}else for(let f=0;f<p;f++){for(let _=0;_<d;_++)a[g+_]=e[m+_];m+=t,g+=o}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!te(t.mosaicsData))throw new F.Z("mapview-invalid-resource","unsuitable data type!");const r=e.spriteData,a=i.data;a&&r||console.error("Source or target images are uninitialized!"),ke._copyBits(r,e.spriteSize[0],0,0,a,e.pageSize[0],e.rect.x+T.fL,e.rect.y+T.fL,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*T.fL,t+=2*T.fL;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const a=ce(2,Math.ceil((0,Tt.k3)(e))),o=ce(2,Math.ceil((0,Tt.k3)(t))),l=new G.Z(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*o)},size:[a,o],dirty:!0,texture:void 0}),[l,this._mosaicPages.length-1,[a,o]]}const r=this._binPack.allocate(e,t);if(r.width<=0){const a=this._mosaicPages[this._currentPage];return!a.dirty&&te(a.mosaicsData)&&(a.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Fe(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[r,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;te(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}const St=new Uint32Array(256);for(let n=0;n<256;n++){let e=n;for(let t=0;t<8;t++)e=0!=(1&e)?3988292384^e>>>1:e>>>1;St[n]=e}const is=new F.Z("Not a PNG"),Pt=new F.Z("Not an animated PNG"),He=new Uint8Array([137,80,78,71,13,10,26,10]);function Ft(n){const e=n.constructor===Uint8Array?n:new Uint8Array(n);return!He.some((t,i)=>t!==e[i])}class Ne{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static create(e,t){return(0,y.Z)(function*(){const i=new Ne;try{yield i._load(e,t)}catch(r){if(!(0,z.D_)(r))return new F.Z("invalid-resource",`Could not load PNG: ${r.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const r=this.frameChanged();if(!r)return!1;const a=this.currentFrame,o=a.frameData,l=t.descriptor;return(a.left||a.top||a.width!==l.width||a.height!==l.height)&&t.setData(null),t.updateData(0,a.left,a.top,a.width,a.height,o),this.updateUsedFrame(),r}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(e,t){var i=this;return(0,y.Z)(function*(){try{const r=function(n,e){const t=new Uint8Array(e);if(He.some((u,m)=>u!==t[m]))return is;let i=!1;if(Re(t,u=>!(i="acTL"===u)),!i)return Pt;const r=[],a=[];let o=null,l=null,h=0;if(Re(t,(u,m,g,f)=>{const _=new DataView(m.buffer);switch(u){case"IHDR":o=m.subarray(g+8,g+8+f),n.width=_.getUint32(g+8),n.height=_.getUint32(g+12);break;case"acTL":n.numPlays=_.getUint32(g+8+4);break;case"fcTL":{l&&(n.frames.push(l),h++),l=new ns,l.width=_.getUint32(g+8+4),l.height=_.getUint32(g+8+8),l.left=_.getUint32(g+8+12),l.top=_.getUint32(g+8+16);const x=_.getUint16(g+8+20);let w=_.getUint16(g+8+22);0===w&&(w=100),l.delay=1e3*x/w,l.delay<=10&&(l.delay=100),n.playTime+=l.delay,l.disposeOp=_.getUint8(g+8+24),l.blendOp=_.getUint8(g+8+25),l.dataParts=[],0===h&&2===l.disposeOp&&(l.disposeOp=1);break}case"fdAT":l&&l.dataParts.push(m.subarray(g+8+4,g+8+f));break;case"IDAT":l&&l.dataParts.push(m.subarray(g+8,g+8+f));break;case"IEND":a.push(Rt(m,g,12+f));break;default:r.push(Rt(m,g,12+f))}}),0===n.frames.length)return Pt;n.frameCount=n.frames.length;const d=new Blob(r),p=new Blob(a);return n.frames.forEach(u=>{let m=[];m.push(He),o.set(zt(u.width),0),o.set(zt(u.height),4),m.push(Dt("IHDR",o)),m.push(d),u.dataParts.forEach(g=>m.push(Dt("IDAT",g))),m.push(p),u.data=new Blob(m,{type:"image/png"}),delete u.dataParts,m=null}),n}(i,e);if(r!==i)return r;i._resizeCanvas=document.createElement("canvas"),i._resizeCanvas.width=i.width,i._resizeCanvas.height=i.height,yield Promise.all(i.frames.map(a=>a.createImage(i._resizeCanvas)))}catch(r){if(!(0,z.D_)(r))return new F.Z("invalid-resource","Could not parse PNG")}i.play()})()}_play(){let e,t;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout(()=>this._play(),e)}}class ns{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}createImage(e){var t=this;return(0,y.Z)(function*(){if(null===t.imageData)return new Promise((i,r)=>{const a=URL.createObjectURL(t.data),o=document.createElement("img");o.onload=()=>{URL.revokeObjectURL(a),t.imageData=function(n,e){e.width=n.width,e.height=n.height;const t=e.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const i=t.getImageData(0,0,n.width,n.height),r=new Uint8Array(i.data);let a;for(let o=0;o<r.length;o+=4)a=r[o+3]/255,r[o]=r[o]*a,r[o+1]=r[o+1]*a,r[o+2]=r[o+2]*a;return new ImageData(new Uint8ClampedArray(r.buffer),n.width,n.height)}(o,e),i()},o.onerror=()=>{URL.revokeObjectURL(a),t.imageData=null,r(new Error("Image creation error"))},o.src=a})})()}}function Re(n,e){const t=new DataView(n.buffer);let i,r,a,o=8;do{r=t.getUint32(o),i=os(n,o+4,4),a=e(i,n,o,r),o+=12+r}while(!1!==a&&"IEND"!==i&&o<n.length)}function os(n,e,t){const i=Array.prototype.slice.call(n.subarray(e,e+t));return String.fromCharCode.apply(String,i)}function Rt(n,e,t){const i=new Uint8Array(t);return i.set(n.subarray(e,e+t)),i}function Dt(n,e){const t=n.length+e.length,i=new Uint8Array(t+8),r=new DataView(i.buffer);r.setUint32(0,e.length),i.set(function(n){const e=new Uint8Array(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}(n),4),i.set(e,8);const a=function(n,e=0,t=n.length-e){let i=-1;for(let r=e,a=e+t;r<a;r++)i=i>>>8^St[255&(i^n[r])];return-1^i}(i,4,t);return r.setUint32(t+4,a),i}function zt(n){return new Uint8Array([n>>>24&255,n>>>16&255,n>>>8&255,255&n])}function Bt(n){if(!n||0===n.byteLength)return!1;const e=n.constructor===Uint8Array?n:new Uint8Array(n);return 71===e[0]&&73===e[1]&&70===e[2]&&56===e[3]}class Ge{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static create(e,t){return(0,y.Z)(function*(){const i=new Ge;try{yield i._load(e,t)}catch(r){if(!(0,z.D_)(r))return new F.Z("invalid-resource",`Could not load PNG: ${r.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const r=this.frameChanged();if(r){const a=this.currentFrame;t.updateData(0,0,0,a.width,a.height,a.frameData),this.updateUsedFrame()}return r}seekFrame(e){clearTimeout(this.timerID),this.currentFrameNumber=e%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(e){clearTimeout(this.timerID),e<0&&(e=0),e*=1e3,e%=this.length;let t=0;for(;e>this.frames[t].time+this.frames[t].delay&&t<this.frames.length;)t+=1;this.currentFrameNumber=t,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(e,t){var i=this;return(0,y.Z)(function*(){try{i.loading=!0,yield i._parse(e,t),i.loading=!1,i.play()}catch(r){if(!(0,z.D_)(r))return new F.Z("invalid-resource","Could not parse gif!")}})()}_parse(e,t){const i=new ds(e);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const r=i.data[i.pos++];return this.globalColourCount=1<<1+(7&r),i.pos++,i.pos++,128&r&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise((a,o)=>{setTimeout(()=>this._parseBlock(i,a,o,t),0)})}_parseBlock(e,t,i,r){var a=this;return(0,y.Z)(function*(){if(r&&r.signal&&(0,z.Hc)(r.signal))return void i((0,z.zE)());const o=e.data[e.pos++];if(44===o){if(a._parseImg(e),a.firstFrameOnly)return a._finishedLoading(),void t()}else{if(59===o)return a._finishedLoading(),void t();a._parseExt(e)}"function"==typeof a.onprogress&&a.onprogress({bytesRead:e.pos,totalBytes:e.data.length,frame:a.frames.length}),setTimeout(()=>a._parseBlock(e,t,i,r),0)})()}_parseColourTable(e,t){const i=[];for(let r=0;r<e;r++)i.push([t.data[t.pos++],t.data[t.pos++],t.data[t.pos++]]);return i}_parseImg(e){const i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,i.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0,i.leftPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.topPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.width=e.data[e.pos++]+(e.data[e.pos++]<<8),i.height=e.data[e.pos++]+(e.data[e.pos++]<<8);const r=e.data[e.pos++];i.localColourTableFlag=!!(128&r),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&r),e)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(e.data[e.pos++],e.readSubBlocksB()),64&r?(i.interlaced=!0,(a=>{const o=this.pixelBufSize/a;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let l=0;for(let h=0;h<4;h++)for(let d=this.interlaceOffsets[h];d<o;d+=this.interlaceSteps[h])this.deinterlaceBuf.set(this.pixelBuf.subarray(l,l+a),d*a),l+=a})(i.width)):i.interlaced=!1,this._processFrame(i)}_lzwDecode(e,t){let i,r,a,o,l,h,d,p,u;a=r=0;let m=[];const g=1<<e,f=g+1;for(o=e+1,u=!1;!u;){for(h=l,l=0,i=0;i<o;i++)t[a>>3]&1<<(7&a)&&(l|=1<<i),a++;if(l===g){for(m=[],o=e+1,i=0;i<g;i++)m[i]=[i];m[g]=[],m[f]=null}else{if(l===f)return void(u=!0);for(l>=m.length?m.push(m[h].concat(m[h][0])):h!==g&&m.push(m[h].concat(m[l][0])),d=m[l],p=d.length,i=0;i<p;i++)this.pixelBuf[r++]=d[i];m.length===1<<o&&o<12&&o++}}}_processFrame(e){e.image=document.createElement("canvas"),e.image.width=this.width,e.image.height=this.height,e.ctx=e.image.getContext("2d");const t=e.localColourTableFlag?e.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=e);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||e.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const r=e.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),a=e.transparencyIndex,o=r.data,l=e.interlaced?this.deinterlaceBuf:this.pixelBuf,h=l.length;let d,p,u=0;for(let m=0;m<h;m++)d=l[m],p=t[d],a!==d?(o[u++]=p[0],o[u++]=p[1],o[u++]=p[2],o[u++]=255):(i&&(o[u+3]=0),u+=4);e.ctx.putImageData(r,e.leftPos,e.topPos),this.lastFrame=e}_parseExt(e){const t=e.data[e.pos++];249===t?this._parseGCExt(e):254===t?this.comment+=e.readSubBlocks():255===t?this._parseAppExt(e):(1===t&&(e.pos+=13),e.readSubBlocks())}_parseAppExt(e){e.pos+=1,"NETSCAPE"===e.getString(8)?e.pos+=8:(e.pos+=3,e.readSubBlocks())}_parseGCExt(e){e.pos++;const t=e.data[e.pos++];this.disposalMethod=(28&t)>>2,this.transparencyGiven=!!(1&t),this.delayTime=e.data[e.pos++]+(e.data[e.pos++]<<8),this.transparencyIndex=e.data[e.pos++],e.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let e,t;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(()=>this._play(),e)):this.pause()}_setCurrentFrame(e){this.currentFrame={frameData:this.frames[e].image,top:0,left:0,width:this.width,height:this.height}}}class ds{constructor(e){this.pos=0,this.data=new Uint8ClampedArray(e),this.len=this.data.length}getString(e){let t="";for(;e--;)t+=String.fromCharCode(this.data[this.pos++]);return t}readSubBlocks(){let e,t,i="";do{for(t=e=this.data[this.pos++];t--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}readSubBlocksB(){let e,t;const i=[];do{for(t=e=this.data[this.pos++];t--;)i.push(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}}var us=c(83704),We=c(7409),ms=c(50352);const Et=(0,Fi.c)(),Ot="arial-unicode-ms-regular",It=fe.Z.getLogger("esri.views.2d.engine.webgl.TextureManager"),Ut=n=>"esriSMS"===n.type&&n.path;function De(n){switch(n.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function At(n){return"maxVVSize"in n&&n.maxVVSize||n.width}function $e(){return($e=(0,y.Z)(function*(n,e){const t=n.imageData?`data:${n.contentType};base64,${n.imageData}`:n.url;let i;const r=";base64,";if(-1!==t.indexOf(r)){const a=t.indexOf(r)+r.length,o=t.substring(a),l=atob(o),h=new Uint8Array(l.length);for(let d=0;d<l.length;d++)h[d]=l.charCodeAt(d);i=h.buffer}else try{const{data:a}=yield(0,ge.default)(t,N({responseType:"array-buffer"},e));i=a}catch(a){if(!(0,z.D_)(a))return new F.Z("mapview-invalid-resource",`Could not fetch requested resource at ${t}`)}return i})).apply(this,arguments)}function Lt(n,e){const t=Math.round((0,re.F2)(e)*window.devicePixelRatio);return Math.min(n,t*(t>=128?2:4))}const Ke=(n,e,t)=>It.error(new F.Z(n,e,t));class Ye{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new Ye(e,t.page,t.sdf)}}class xs{constructor(e){var t;this._invalidFontsMap=new Map,this._sdfConverter=new qi(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new Ri.Z,this._ongoingRasterizations=new Map,this._imageRequestQueue=new ms.e({concurrency:10,process:(t=(0,y.Z)(function*(i,r){(0,z.k_)(r);try{return yield(0,ge.default)(i,{responseType:"image",signal:r})}catch(a){throw(0,z.D_)(a)?a:new F.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`,a)}}),function(r,a){return t.apply(this,arguments)})}),this._spriteMosaic=new ke(e,2048,2048,500),this._glyphSource=new Wi(`${Pi.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new ki(1024,1024,this._glyphSource)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}rasterizeItem(e,t,i,r){var a=this;return(0,y.Z)(function*(){if((0,v.Wi)(e))return Ke("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"CIMTextSymbol":case"esriTS":{const o=yield a._rasterizeText(e,i,r);return o.forEach(l=>a._setTextureBinding(R.Un.GLYPH,l)),{glyphMosaicItems:o}}default:{if((n=e).type&&-1!==n.type.toLowerCase().indexOf("3d"))return Ke("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const o=yield a._rasterizeSpriteSymbol(e,t,r);return(0,We.ok)(o)&&o&&a._setTextureBinding(R.Un.SPRITE,o),{spriteMosaicItem:o}}}var n})()}bindTextures(e,t,i,r=!1){if(0===i.textureBinding)return;const a=this._bindingInfos[i.textureBinding-1],o=a.page,l=r?9987:9729;switch(a.mosaicType){case R.Un.SPRITE:{const h=this.sprites.getWidth(o),d=this.sprites.getHeight(o),p=(0,D.s)(Et,h,d);return this._spriteMosaic.bind(e,l,o,T.D3),t.setUniform1i("u_texture",T.D3),void t.setUniform2fv("u_mosaicSize",p)}case R.Un.GLYPH:{const p=(0,D.s)(Et,this.glyphs.width,this.glyphs.height);return this._glyphMosaic.bind(e,l,o,T.Al),t.setUniform1i("u_texture",T.Al),void t.setUniform2fv("u_mosaicSize",p)}default:It.error("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const r=Ye.fromMosaic(e,t);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(r)}t.textureBinding=this._hashToBindingIndex.get(i)}_rasterizeText(e,t,i){var r=this;return(0,y.Z)(function*(){const a=function(n){const e=function(n){if(!n.weight)return"";switch(n.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(n)+function(n){if(!n.style)return"";switch(n.style.toLowerCase()){case"italic":case"oblic":return"-italic"}return""}(n);return function(n){const e=n.toLowerCase().split(" ").join("-");switch(e){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return e}}(n.family)+(e.length>0?e:"-regular")}(e.font),o=r._invalidFontsMap.has(a),l=t||function(n){const e=[];for(let t=0;t<n.length;t++)e.push(n.charCodeAt(t));return e}((0,us.E)(e.text)[0]);try{return yield r._glyphMosaic.getGlyphItems(o?Ot:a,l,i)}catch(h){return Ke("mapview-invalid-resource",`Couldn't find font ${a}. Falling back to Arial Unicode MS Regular`),r._invalidFontsMap.set(a,!0),r._glyphMosaic.getGlyphItems(Ot,l,i)}})()}_rasterizeSpriteSymbol(e,t,i){var r=this;return(0,y.Z)(function*(){if(function(n){switch(n.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===n.style||"esriSFSNull"===n.style;case"esriSLS":return"esriSLSSolid"===n.style||"esriSLSNull"===n.style;default:return!1}}(e))return null;const a=function(n){switch(n.type){case"esriSMS":return`${n.style}.${n.path}`;case"esriSLS":return`${n.style}.${n.cap}`;case"esriSFS":return`${n.style}`;case"esriPFS":case"esriPMS":return n.imageData?`${n.imageData}${n.width}${n.height}`:`${n.url}${n.width}${n.height}`;default:return n.mosaicHash?n.mosaicHash:JSON.stringify(n)}}(e);if(r._spriteMosaic.has(a))return r._spriteMosaic.getSpriteItem(a);if(Ut(e)||(n=e).url||n.imageData)return r._handleAsyncResource(a,e,i);var n;const l=r._rasterizer.rasterizeJSONResource(e,1);if(l){const{size:h,image:d,sdf:p,simplePattern:u}=l;return r._addItemToMosaic(a,h,{type:"static",data:d},De(e),p,u)}return new F.Z("TextureManager","unrecognized or null rasterized image")})()}_handleAsyncResource(e,t,i){var r=this;return(0,y.Z)(function*(){if(r._ongoingRasterizations.has(e))return r._ongoingRasterizations.get(e);let a;a=Ut(t)?r._handleSVG(t,e,i):r._handleImage(t,e,i),r._ongoingRasterizations.set(e,a);try{yield a,r._ongoingRasterizations.delete(e)}catch(o){r._ongoingRasterizations.delete(e)}return a})()}_handleSVG(e,t,i){var r=this;return(0,y.Z)(function*(){const o=yield r._sdfConverter.draw(e.path,i);return r._addItemToMosaic(t,[126,126],{type:"static",data:new Uint32Array(o.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,t,i){var r=this;return(0,y.Z)(function*(){const a=yield function(n,e){return $e.apply(this,arguments)}(e,i);if((0,We.ok)(a)){const o=Bt(a),l=Ft(a);if(!o&&!l)return new F.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let h;try{o&&function(n){if(!n||0===n.byteLength)return!1;const e=new Uint8Array(n);if(!Bt(e))return!1;let t=0;for(let i=0,r=e.length-9;i<r&&(0!==e[i]||33!==e[i+1]||249!==e[i+2]||4!==e[i+3]||0!==e[i+8]||44!==e[i+9]&&33!==e[i+9]||(t++,!(t>1)));++i);return t>1}(a)?h=yield Ge.create(a,i):l&&function(n){const e=new Uint8Array(n);if(!Ft(e))return!1;let t=!1;return Re(e,i=>!(t="acTL"===i)),t}(a)&&(h=yield Ne.create(a,i))}catch(u){if(!(0,z.D_)(u))return new F.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(h&&(0,We.ok)(h))return r._addItemToMosaic(t,[h.width,h.height],{type:"animated",data:h},De(e),!1,!1);const d=new Blob([a],{type:o?"image/gif":"image/png"}),p=yield r._imageFromBlob(d);if(p&&p instanceof HTMLImageElement){let u=p.width,m=p.height;"esriPMS"===e.type&&(u=Math.round(Lt(p.width,At(e))),m=Math.round(p.height*(u/p.width)));const{size:g,sdf:f,image:_}=r._rasterizer.rasterizeImageResource(u,m,p,e.colorSubstitutions);return r._addItemToMosaic(t,g,{type:"static",data:_},De(e),f,!1)}}return new F.Z("mapview-invalid-resource","Could not handle resource!")})()}_handleImage(e,t,i){var r=this;return(0,y.Z)(function*(){if((n=e).url&&-1!==n.url.indexOf(".gif")||n.contentType&&"image/gif"===n.contentType||n.imageData&&-1!==n.imageData.indexOf("data:image/gif")||(n=>n.url&&-1!==n.url.indexOf(".png")||n.contentType&&"image/png"===n.contentType||n.imageData&&-1!==n.imageData.indexOf("data:image/png"))(e))return r._handleGIFOrPNG(e,t,i);var n;const a=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;try{const{data:o}=yield r._imageRequestQueue.push(a,N({},i));(n=>-1!==n.indexOf("data:image/svg+xml"))(a)&&(o.width=(0,re.F2)(e.width),o.height=(0,re.F2)(e.height));let l=o.width,h=o.height;"esriPMS"===e.type&&(l=Math.round(Lt(o.width,At(e))),h=Math.round(o.height*(l/o.width)));const{size:d,sdf:p,image:u}=r._rasterizer.rasterizeImageResource(l,h,o,e.colorSubstitutions);return r._addItemToMosaic(t,d,{type:"static",data:u},De(e),p,!1)}catch(o){if(!(0,z.D_)(o))return new F.Z("mapview-invalid-resource",`Could not fetch requested resource at ${a}. ${o.message}`)}})()}_imageFromBlob(e){var t=this;return(0,y.Z)(function*(){const i=window.URL.createObjectURL(e);try{const{data:r}=yield t._imageRequestQueue.push(i);return window.URL.revokeObjectURL(i),r}catch(r){if(window.URL.revokeObjectURL(i),!(0,z.D_)(r))return new F.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`);throw r}})()}_addItemToMosaic(e,t,i,r,a,o){return this._spriteMosaic.addSpriteItem(e,t,i,r,a,o)}}var Qe=c(10269);class ze{constructor(){this.name=this.constructor.name}}class Cs extends ze{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:r}=e;this._quad||(this._quad=new Qe.Z(i,[0,0,1,0,0,1,1,1]));const a=i.getBoundFramebufferObject(),{x:o,y:l,width:h,height:d}=i.getViewport();t.bindTextures(i);const p=t.getBlock(T.xl);if((0,v.Wi)(p))return;const u=p.getFBO(i),m=p.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,m,r.labelsAnimationTime),this._updateAnimationState(e,m,u),i.bindFramebuffer(a),i.setViewport(o,l,h,d)}_computeDelta(e,t,i){const{context:r,painter:a,displayLevel:o}=e,l=a.materialManager.getProgram(e,this._desc,["delta"]);r.bindFramebuffer(t),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(l),l.setUniform1i("u_maskTexture",T.iJ),l.setUniform1i("u_sourceTexture",T.nM),l.setUniform1f("u_timeDelta",e.deltaTime),l.setUniform1f("u_animationTime",i),l.setUniform1f("u_zoomLevel",Math.round(10*o)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:r,painter:a}=e,o=a.materialManager.getProgram(e,this._desc,["update"]);r.bindTexture(t.colorTexture,1),r.useProgram(o),o.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const Vt=n=>`#define ${(n=>n.replace("-","_").toUpperCase())(n)}\n`,Zt={attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:n=>({vertexShader:Vt(n)+(0,A.w)("blend/blend.vert"),fragmentShader:Vt(n)+(0,A.w)("blend/blend.frag")})},kt=fe.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Ts{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(e,t,i,r,a){const{context:o,drawPhase:l}=e;if(this._setupShader(o),r&&"normal"!==r&&l!==R.jx.LABEL)return void this._drawBlended(e,t,i,r,a);const h=this._programCache.getProgram(Zt,"normal");if(!h)return void kt.error(new F.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));o.useProgram(h),t.setSamplingMode(i),o.bindTexture(t,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",a),o.setBlendingEnabled(!0),o.setBlendFunction(1,771);const d=this._quad;d.draw(),d.unbind()}_drawBlended(e,t,i,r,a){const{context:o,state:l,pixelRatio:h,inFadeTransition:d}=e,{size:p}=l,u=o.getBoundFramebufferObject();let m,g;if((0,v.pC)(u)){const w=u.descriptor;m=w.width,g=w.height}else m=Math.round(h*p[0]),g=Math.round(h*p[1]);this._createOrResizeTexture(e,m,g);const f=this._backBufferTexture;u.copyToTexture(0,0,m,g,0,0,f),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const _=this._programCache.getProgram(Zt,r);if(!_)return void kt.error(new F.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${r}`));o.useProgram(_),f.setSamplingMode(i),o.bindTexture(f,0),_.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),_.setUniform1i("u_layerTexture",1),_.setUniform1f("u_opacity",a),_.setUniform1f("u_inFadeOpacity",d?1:0),o.setBlendFunction(1,0);const x=this._quad;x.draw(),x.unbind(),o.setBlendFunction(1,771)}_setupShader(e){this._programCache||(this._programCache=new wt.Z(e),this._quad||(this._quad=new Qe.Z(e,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(e,t,i){const{context:r}=e;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new Y.Z(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Ht extends ze{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:r}=e.getViewport(),a=t.getFbos(i,r).effect0;e.bindFramebuffer(a),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:r,state:a,deltaTime:o}=e,l=r.getPostProcessingEffects(t.effects),h=i.getBoundFramebufferObject();l.length&&t.transitionStep(o,a.scale);for(const{postProcessingEffect:d,effect:p}of l)d.draw(e,h,p);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),r.blitTexture(i,h.colorTexture,9728),i.setStencilTestEnabled(!0)}}const Ss=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Ps=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Je=fe.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),Rs=[0,0,0,0];class Ds{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:.7,innerHaloWidth:.7,outerHaloWidth:.7},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;!function(n,e){e.fillColor[0]=n.color.r/255,e.fillColor[1]=n.color.g/255,e.fillColor[2]=n.color.b/255,e.fillColor[3]=n.color.a,n.haloColor?(e.outlineColor[0]=n.haloColor.r/255,e.outlineColor[1]=n.haloColor.g/255,e.outlineColor[2]=n.haloColor.b/255,e.outlineColor[3]=n.haloColor.a):(e.outlineColor[0]=e.fillColor[0],e.outlineColor[1]=e.fillColor[1],e.outlineColor[2]=e.fillColor[2],e.outlineColor[3]=e.fillColor[3]),e.fillColor[3]*=n.fillOpacity,e.outlineColor[3]*=n.haloOpacity,e.fillColor[0]*=e.fillColor[3],e.fillColor[1]*=e.fillColor[3],e.fillColor[2]*=e.fillColor[3],e.outlineColor[0]*=e.outlineColor[3],e.outlineColor[1]*=e.outlineColor[3],e.outlineColor[2]*=e.outlineColor[3],e.outlineWidth=.7,e.outerHaloWidth=.7,e.innerHaloWidth=.7,e.outlinePosition=0}(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,r=t.outlinePosition-t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2,o=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,l=1*Math.sqrt(Math.PI/2),h=Math.abs(i)>l?Math.round(10*(Math.abs(i)-l))/10:0,d=Math.abs(o)>l?Math.round(10*(Math.abs(o)-l))/10:0;let p;h&&!d?Je.error("The outer rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!h&&d?Je.error("The inner rim of the highlight is "+d+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):h&&d&&Je.error("The highlight is "+Math.max(h,d)+"px away from the edge of the feature; consider reducing some width values.");const u=[void 0,void 0,void 0,void 0];function m(f,_,x){u[0]=(1-x)*f[0]+x*_[0],u[1]=(1-x)*f[1]+x*_[1],u[2]=(1-x)*f[2]+x*_[2],u[3]=(1-x)*f[3]+x*_[3]}const{texelData:g}=this;for(let f=0;f<256;++f)p=i+f/255*(o-i),p<i?(u[4*f+0]=0,u[4*f+1]=0,u[4*f+2]=0,u[4*f+3]=0):p<r?m(Rs,t.outlineColor,(p-i)/(r-i)):p<a?[u[0],u[1],u[2],u[3]]=t.outlineColor:p<o?m(t.outlineColor,t.fillColor,(p-a)/(o-a)):[u[4*f+0],u[4*f+1],u[4*f+2],u[4*f+3]]=t.fillColor,g[4*f+0]=255*u[0],g[4*f+1]=255*u[1],g[4*f+2]=255*u[2],g[4*f+3]=255*u[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=o,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new Y.Z(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,T.Jw),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const zs={shaders:{vertexShader:(0,A.w)("highlight/textured.vert"),fragmentShader:(0,A.w)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Bs={shaders:{vertexShader:(0,A.w)("highlight/textured.vert"),fragmentShader:(0,A.w)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class Es{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,T.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ss),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,T.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ps),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,T.QU),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(1,771),e.drawArrays(5,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const r=pe.Z.createVertex(e,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),a=new Pe.Z(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:r}),o=(0,Z.H)(e,zs),l=(0,Z.H)(e,Bs);o.setUniform1i("u_texture",T.QU),o.setUniform1i("u_shade",T.Jw),o.setUniform1f("u_sigma",1),l.setUniform1i("u_texture",T.QU),l.setUniform1f("u_sigma",1),this._resources={quadGeometry:r,quadVAO:a,highlightProgram:o,blurProgram:l}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}function Nt(n,e,t){const i=new Y.Z(n,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:e,height:t,samplingMode:9729});return[i,new ee.Z(n,{colorTarget:0,depthStencilTarget:2},i)]}class Os{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[r,a]=Nt(e,t,i),[o,l]=Nt(e,t,i);this._resources={sharedBlur1Tex:r,sharedBlur1Fbo:a,sharedBlur2Tex:o,sharedBlur2Fbo:l}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Is extends ze{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new Es,this._hlGradient=new Ds,this._width=void 0,this._height=void 0,this._hlSurfaces=new Os,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new bt}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:r,height:a}=t.getViewport(),o=i.getFbos(r,a).effect0;this.setup(e,r,a),t.bindFramebuffer(o),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const r=t%4,a=i%4;i+=a<2?-a:4-a,this._adjustedWidth=t+=r<2?-r:4-r,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const o=Math.round(1*t),l=Math.round(1*i);this._hlRenderer.setup(e,o,l),this._hlSurfaces.setup(e,o,l)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,9728,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class Us extends ze{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,v.pC)(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:r}=e.getViewport(),a=t.getFbos(i,r).effect0;e.bindFramebuffer(a),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw({context:e,state:t,pixelRatio:i},r,a=T.Jc){const o=e.getBoundFramebufferObject(),l=t.size[1]*i,h=Math.round(a*i),d=h/2,p=h/2;this._ensureBuffer(h),r.forEach((u,m)=>{const g=new Map,f=Math.floor(m[0]*i-h/2),_=Math.floor(l-m[1]*i-h/2);o.readPixels(f,_,h,h,6408,5121,this._buf);for(let w=0;w<this._buf32.length;w++){const M=this._buf32[w];if(4294967295!==M&&0!==M){const P=w%h,C=h-Math.floor(w/h),H=(d-P)*(d-P)+(p-C)*(p-C),L=g.has(M)?g.get(M):4294967295;g.set(M,Math.min(H,L))}}const x=Array.from(g).sort((w,M)=>w[1]-M[1]).map(w=>w[0]);u.resolve(x),r.delete(m)})}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}function As(n){switch(n){case"bloom":case"blur":case"opacity":case"drop-shadow":return n;default:return"colorize"}}const Ls={colorize:(n=(0,y.Z)(function*(){return new((yield c.e(6993).then(c.bind(c,16993))).Colorize)}),function(){return n.apply(this,arguments)}),blur:function(){var n=(0,y.Z)(function*(){return new((yield c.e(644).then(c.bind(c,40644))).Blur)});return function(){return n.apply(this,arguments)}}(),bloom:function(){var n=(0,y.Z)(function*(){return new((yield c.e(9589).then(c.bind(c,89589))).Bloom)});return function(){return n.apply(this,arguments)}}(),opacity:function(){var n=(0,y.Z)(function*(){return new((yield c.e(5159).then(c.bind(c,65159))).Opacity)});return function(){return n.apply(this,arguments)}}(),"drop-shadow":function(){var n=(0,y.Z)(function*(){return new((yield c.e(9969).then(c.bind(c,69969))).DropShadow)});return function(){return n.apply(this,arguments)}}()};var n;class Vs{constructor(e){this._requestRender=e,this._effectMap=new Map,this._effectPromiseMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear(),this._effectPromiseMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const t=[];for(const i of e){const r=As(i.type),a=this._effectMap.get(r);a?t.push({postProcessingEffect:a,effect:i}):this._enablePostProcessingEffect(r)}return t}_enablePostProcessingEffect(e){var t=this;return(0,y.Z)(function*(){const i=yield t._loadPostProcessingEffect(e);t._requestRender&&(t._effectMap.set(e,i),t._requestRender.requestRender())})()}_loadPostProcessingEffect(e){var t=this;return(0,y.Z)(function*(){return t._effectPromiseMap.has(e)||t._effectPromiseMap.set(e,Ls[e]()),t._effectPromiseMap.get(e)})()}}var Zs=c(52690);class ks{constructor(e,t){var i;this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||R.jx.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=null!=(i=t.enableDefaultDraw)?i:()=>!0}render(e){const{context:t,profiler:i}=e,r=this._targetFn(),a=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),a){this.enableDefaultDraw()&&this._doRender(e,r),i.recordPassEnd();for(const o of this.effects){if(!o.enable())continue;const l=o.apply;i.recordPassStart(this.name+"."+l.name),i.recordBrushStart(l.name);const h=o.args&&o.args(),{x:d,y:p,width:u,height:m}=t.getViewport(),g=t.getBoundFramebufferObject();l.bind(e,h),this._doRender(e,r,l.defines),l.draw(e,h),l.unbind(e,h),t.bindFramebuffer(g),t.setViewport(d,p,u,m),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!(0,v.Wi)(t))if((0,Zs.zG)(t)){for(const r of t)if(r.visible)for(const a of this.brushes)e.profiler.recordBrushStart(a.name),a.prepareState(e,r,i),a.draw(e,r,i),e.profiler.recordBrushEnd()}else for(const r of this.brushes)e.profiler.recordBrushStart(r.name),r.prepareState(e,t,i),r.draw(e,t,i),e.profiler.recordBrushEnd()}}const Hs={[R.LW.FILL]:ne.U.fill,[R.LW.LINE]:ne.U.line,[R.LW.MARKER]:ne.U.marker,[R.LW.TEXT]:ne.U.text};class Ns{constructor(e,t){this.context=e,this._blitRenderer=new bt,this._brushCache=new Map,this._vtlMaterialManager=new wi,this._blendEffect=new Ts,this.effects={highlight:new Is,hittest:new Us,integrate:new Cs,insideEffect:new Ht("inside"),outsideEffect:new Ht("outside")},this.materialManager=new Si(e),this.textureManager=new xs(t),this._effectsManager=new Vs(t)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const o in this._fbos)this._fbos[o].resize(e,t);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},r={colorTarget:0,depthStencilTarget:3},a=new hi.Z(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=a,this._fbos={output:new ee.Z(this.context,r,i,a),blend:new ee.Z(this.context,r,i,a),effect0:new ee.Z(this.context,r,i,a)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:r}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const a=this.getFbos(i,r);if(e.bindFramebuffer(a.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),(0,v.pC)(t)){const{r:o,g:l,b:h,a:d}=t.color;e.setClearColor(d*o/255,d*l/255,d*h/255,d)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:r,blendMode:a,effects:o,requireFBO:l}=e;if(l||Gt(a,o,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{const h=this._getOutputFBO();r.bindFramebuffer(h)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:r,effects:a,requireFBO:o}=e;if(o||Gt(r,a,t)){(0,v.pC)(a)&&a.length>0&&e.drawPhase===R.jx.MAP&&this._applyEffects(e,a);const l=this._getOutputFBO();i.bindFramebuffer(l),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);const h=(0,v.pC)(r)?r:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,h,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(e){const t=Hs[e];let i=this._brushCache.get(t);return void 0===i&&(i=new t,this._brushCache.set(t,i)),this._brushCache.get(t)}renderObject(e,t,i,r){const a=ne.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.prepareState(e,t,r),o.draw(e,t,r)}renderObjects(e,t,i,r){const a=ne.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.drawMany(e,t,r)}registerRenderPass(e){const t=e.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new ks(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,r=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,r)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,r=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:a,effect:o}of r)i.bindFramebuffer(this._fbos.blend),a.draw(e,this._fbos.blend,o)}}function Gt(n,e,t){return 1!==t||(0,v.pC)(n)&&"normal"!==n||(0,v.pC)(e)&&e.length>0}var Gs=c(87283),Ws=c(77624),js=c(40623);const W=(0,Se.Z)("esri-2d-profiler");class $s{constructor(e,t){if(this._events=new Ws.Z,this._entries=new Map,this._timings=new Gs.Z(10),!W)return;this._ext=(0,js.m)(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging)for(const r in i)if("function"==typeof i[r]){const a=i[r],o=-1!==r.indexOf("draw");i[r]=(...l)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:r,args:l,isDrawCommand:o}),this._currentSummary&&(this._currentSummary.commands++,o&&this._currentSummary.drawCommands++),a.apply(i,l))}}get enableCommandLogging(){return!("object"==typeof W&&W.disableCommands)}recordContainerStart(e){W&&(this._currentContainer=e)}recordContainerEnd(){W&&(this._currentContainer=null)}recordPassStart(e){W&&(this._currentPass=e,this._initSummary())}recordPassEnd(){W&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){W&&(this._currentBrush=e)}recordBrushEnd(){W&&(this._currentBrush=null)}recordStart(e){if(W&&(0,v.pC)(this._ext)){if(this._entries.has(e)){const i=this._entries.get(e),r=this._ext.resultAvailable(i.query),a=this._ext.disjoint();if(r&&!a){const o=this._ext.getResult(i.query)/1e6;let l=0;if((0,v.pC)(this._timings.enqueue(o))){const p=this._timings.entries,u=p.length;let m=0;for(const g of p)m+=g;l=m/u}const h=o.toFixed(2),d=l?l.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${h} ms (${d} last 10 avg)\n${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${h} ms (${d} last 10 avg)`),this._debugOutput.innerHTML=`${h} (${d})`}for(const o of i.handles)o.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",i=>{t.commandsLen++,t.commands.push(i),i.isDrawCommand&&t.drawCommands++})),t.handles.push(this._events.on("summary",i=>{t.summaries.push(i)}))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){W&&(0,v.pC)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}var Ks=c(11173);const Ys=fe.Z.getLogger("esri.views.2d.engine.webgl.WebGLDriverTest");class Qs{constructor(e){this.svgAlwaysPremultipliesAlpha=!1,this._ignoresSamplerPrecision=null,this._context=e,(0,Ks.M)(e).then(t=>{this.svgAlwaysPremultipliesAlpha=!t})}get ignoresSamplerPrecision(){return(0,v.Wi)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Js(this._context)),this._ignoresSamplerPrecision}}const Xs=n=>new Qs(n),Js=n=>{const e=new ee.Z(n,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),r=new Uint8Array(4),a=new Qe.Z(n,[0,0,1,0,0,1,1,1]),o=new ut.$(n,"\nprecision highp float;\n\nattribute vec2 a_pos;\n\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\n\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",new Map([["a_pos",0]])),l=new Y.Z(n,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));o.setUniform1i("u_texture",0),n.bindTexture(l,0);const h=n.getBoundFramebufferObject();n.bindFramebuffer(e),n.useProgram(o);const{x:d,y:p,width:u,height:m}=n.getViewport();n.setViewport(0,0,1,1),a.draw(),n.setViewport(d,p,u,m),e.readPixels(0,0,1,1,6408,5121,r),o.dispose(),a.dispose(),e.dispose();const g=255!==r[0]||255!==r[1]||255!==r[2]||255!==r[3];return g&&Ys.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${r[0]}.${r[1]}.${r[2]}.${r[3]}]`),n.bindFramebuffer(h),g},Wt={shaders:{vertexShader:(0,A.w)("stencil/stencil.vert"),fragmentShader:(0,A.w)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};var qs=c(16158),oe=c(90484);class tn extends dt.W{constructor(e,t){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=(0,K.a)(),this._upperRight=(0,K.a)(),this._lowerLeft=(0,K.a)(),this._lowerRight=(0,K.a)(),this._mat2=(0,ai.c)(),this._clipRendererInitialized=!1,this._supersampleScreenshots=!0,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:r=!0,stencil:a=!0,supersampleScreenshots:o=!0,contextOptions:l={}}=t;this._canvas=i;const h=(0,li.s)(i,1,{alpha:r,antialias:!1,depth:!0,stencil:a});this.context=new oi.Z((0,v.pC)(h)?h:null,l),this.painter=new Ns(this.context,this),(0,Se.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:Ze(this.state),pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new qs.T,renderingOptions:t.renderingOptions,requireFBO:!1,driverTestResult:Xs(this.context),profiler:new $s(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,ni.A)({render:d=>this.renderFrame(d)}),this._taskHandle.pause(),this._supersampleScreenshots=o,this._lostWebGLContextHandle=(0,si.on)(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new F.Z("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,lt.S1)(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(e),this.requestRender()}))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=Ze(this._state),this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:(0,ht.c)()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=R.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const r of e)r.processRender(t);this.painter.renderLayers(i),t.drawPhase=R.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=R.jx.LABEL,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);this.painter.renderLayers(i)}if((0,Se.Z)("esri-tiles-debug")){t.drawPhase=R.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const r of e)r.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(e){const{context:t}=this,{state:i,pixelRatio:r}=e;t.enforceState(),t.setClearDepth(1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT);const{size:a,rotation:o}=i,l=Math.round(a[0]*r),h=Math.round(a[1]*r);if(this._boundFBO=t.getBoundFramebufferObject(),!i.spatialReference||!(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable))return void(this._clipFrame=!1);const d=(0,ri.t)(o),p=Math.abs(Math.cos(d)),u=Math.abs(Math.sin(d)),m=Math.round(l*p+h*u),g=Math.round(i.worldScreenWidth);if(m<=g)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===l&&this._clipFBO.height===h||(this._clipFBO=new ee.Z(t,{colorTarget:0,depthStencilTarget:3,width:l,height:h}));const f=(this.state.padding.left-this.state.padding.right)/2,_=(this.state.padding.bottom-this.state.padding.top)/2,x=.5*l,w=.5*h,M=1/l,P=1/h,C=g*r*.5,H=.5*(l*u+h*p),L=this._upperLeft,E=this._upperRight,O=this._lowerLeft,V=this._lowerRight;(0,D.s)(L,-C,-H),(0,D.s)(E,C,-H),(0,D.s)(O,-C,H),(0,D.s)(V,C,H),(0,Ve.i)(this._mat2),(0,Ve.t)(this._mat2,this._mat2,[x+f,w+_]),0!==o&&(0,Ve.r)(this._mat2,this._mat2,d),(0,D.t)(L,L,this._mat2),(0,D.t)(E,E,this._mat2),(0,D.t)(O,O,this._mat2),(0,D.t)(V,V,this._mat2);const ei=this._clipData;ei.set([2*O[0]*M-1,2*(h-O[1])*P-1,2*V[0]*M-1,2*(h-V[1])*P-1,2*L[0]*M-1,2*(h-L[1])*P-1,2*E[0]*M-1,2*(h-E[1])*P-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(ei),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.useProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:i,b:r,a}=this.background.color;e.setClearColor(a*t/255,a*i/255,a*r/255,a)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}doRender(e){const t=this.context,{state:i,pixelRatio:r}=e;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,r*i.size[0],r*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}takeScreenshot(e,t){var i=this;return(0,y.Z)(function*(){const r=(0,oe.$3)(e,i._supersampleScreenshots,i._state.padding),{framebufferWidth:a,framebufferHeight:o}=r,l=i.context,h=e.layers;let d=i.children;const p=i._state.clone();if(null!=e.rotation){const w=p.viewpoint;p.viewpoint.rotation=e.rotation,p.viewpoint=w}const u=me(N({},i._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:Ze(p),pixelRatio:r.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1});h.length>0&&(d=[],h.forEach(w=>{const M=t.find(P=>P.layer.id===w.id);M&&"container"in M&&M.container&&d.push(M.container)}));const m=new ee.Z(l,{colorTarget:0,depthStencilTarget:3,width:a,height:o}),g=l.getBoundFramebufferObject(),f=l.getViewport();l.bindFramebuffer(m),l.setViewport(0,0,a,o),i._renderChildren(d,u);const _=i._readbackScreenshot(r);l.bindFramebuffer(g),l.setViewport(f.x,f.y,f.width,f.height),i.requestRender();const x=i._ensureScreenshotEncodeCanvas();return(0,oe.gH)(_,e,x,{flipY:!0,premultipliedAlpha:!0})})()}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}_readbackScreenshot(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:a}=e,o=this.context.gl;if(a){const l=(0,oe.r7)(t,i,this._ensureScreenshotEncodeCanvas());o.readPixels(0,0,t,i,6408,5121,new Uint8Array(l.data.buffer));const h=(0,oe.r7)(r.width,r.height,this._ensureScreenshotEncodeCanvas());return(0,oe.TT)(l,h,!0,a.region.x,i-(a.region.y+a.region.height),a.region.width,a.region.height)}{const l=(0,oe.r7)(r.width,r.height,this._ensureScreenshotEncodeCanvas());return o.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(l.data.buffer)),l}}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:r},pixelRatio:a}=e,o=r[0],l=r[1],h=Math.round(o*a),d=Math.round(l*a);t.width===h&&t.height===d||(t.width=h,t.height=d),i.width=o+"px",i.height=l+"px"}_initializeClipRenderer(e){if(this._clipRendererInitialized)return!0;const t=Wt.attributes,i=(0,Z.H)(e,Wt);if(!i)return!1;const r=pe.Z.createVertex(e,35040,32),a=new Uint16Array([0,1,2,2,1,3]),o=pe.Z.createIndex(e,35044,a),l=new Pe.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:r},o);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=l,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof dt.W)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}var b=c(60046),le=c(64859),sn=c(10882),nn=c(37925),S=c(9077),he=(c(57025),c(42442)),k=c(22791),rn=c(2679);class an{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/1),r=Math.ceil(t/1);this._cols=i,this._rows=r,this._cells=rn.p.create(i*r)}insertMetrics(e){const t=this._hasCollision(e);return 0===t&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,r=0;e.save();do{const a=e.boundsCount;i+=a;for(let o=0;o<a;o++){const l=e.boundsComputedAnchorX(o),h=e.boundsComputedAnchorY(o),d=e.boundsWidth(o)+2,p=e.boundsHeight(o)+2;switch(this._collide(l,h,d,p)){case 2:return 2;case 1:r++}}}while(e.peekId()===t&&e.next());return e.restore(),i===r?1:0}_collide(e,t,i,r){const a=e-i/2,o=t-r/2,l=a+i,h=o+r;if(l<0||h<0||a>this.width||o>this.height)return 1;const d=(0,k.uZ)(Math.floor(a/1),0,this._cols),p=(0,k.uZ)(Math.floor(o/1),0,this._rows),u=(0,k.uZ)(Math.ceil(l/1),0,this._cols),m=(0,k.uZ)(Math.ceil(h/1),0,this._rows);for(let g=p;g<=m;g++)for(let f=d;f<=u;f++){const _=this.getCellId(f,g);if(this.has(_))return 2}return 0}_mark(e,t,i,r){const a=e-i/2,o=t-r/2,l=a+i,h=o+r,d=(0,k.uZ)(Math.floor(a/1),0,this._cols),p=(0,k.uZ)(Math.floor(o/1),0,this._rows),u=(0,k.uZ)(Math.ceil(l/1),0,this._cols),m=(0,k.uZ)(Math.ceil(h/1),0,this._rows);for(let g=p;g<=m;g++)for(let f=d;f<=u;f++){const _=this.getCellId(f,g);this.set(_)}return!1}_markMetrics(e){const t=e.id;do{const i=e.boundsCount;for(let r=0;r<i;r++){const a=e.boundsComputedAnchorX(r),o=e.boundsComputedAnchorY(r),l=e.boundsWidth(r)+2,h=e.boundsHeight(r)+2;this._mark(a,o,l,h)}}while(e.peekId()===t&&e.next())}}var on=c(74473);const ln=Math.PI;function jt(n,e){switch(e.transformationType){case"additive":return function(n,e){return n+(j(e.minSize,n)||e.minDataValue)}(n,e);case"constant":return function(n,e){const t=n.stops;let i=t&&t.length&&t[0].size;return null==i&&(i=n.minSize),j(i,e)}(e,n);case"clamped-linear":return function(n,e){const t=(n-e.minDataValue)/(e.maxDataValue-e.minDataValue),i=j(e.minSize,n),r=j(e.maxSize,n);return n<=e.minDataValue?i:n>=e.maxDataValue?r:i+t*(r-i)}(n,e);case"proportional":return function(n,e){const t=n/e.minDataValue,i=j(e.minSize,n),r=j(e.maxSize,n);let a=null;return a=t*i,(0,k.uZ)(a,i,r)}(n,e);case"stops":return function(n,e){const[t,i,r]=function(n,e){if(!e)return;let t=0,i=e.length-1;return e.some((r,a)=>n<r?(i=a,!0):(t=a,!1)),[t,i,(n-e[t])/(e[i]-e[t])]}(n,e.cache.ipData);if(t===i)return j(e.stops[t].size,n);{const a=j(e.stops[t].size,n);return a+(j(e.stops[i].size,n)-a)*r}}(n,e);case"real-world-size":return function(n,e){const t=on.a[e.valueUnit],i=j(e.minSize,n),r=j(e.maxSize,n),{valueRepresentation:a}=e;let o=null;return o="area"===a?2*Math.sqrt(n/ln)/t:"radius"===a||"distance"===a?2*n/t:n/t,(0,k.uZ)(o,i,r)}(n,e);case"identity":return n;case"unknown":return null}}function j(n,e){return"number"==typeof n?n:jt(e,n)}function Ce(n,e){const t=[];n.forEachTile(i=>t.push(i)),t.sort((i,r)=>i.instanceId-r.instanceId),t.forEach(i=>{(0,v.pC)(i.labelMetrics)&&i.isReady&&e(i,i.labelMetrics.getCursor())})}function _n(n){return e=>(0,re.F2)(jt(e,n))}function bn(n,e){if(!function(n){return"feature"===n.layer.type||"csv"===n.layer.type||"geojson"===n.layer.type||"ogc-feature"===n.layer.type||"stream"===n.layer.type||"subtype-group"===n.layer.type||"wfs"===n.layer.type}(e))return;const i=e.layer.geometryType,r=!function(n){for(const t of n){var e;const i="featureReduction"in t&&"cluster"===(null==(e=t.featureReduction)?void 0:e.type)&&t.featureReduction,r=[...t.labelingInfo||[],...i.labelingInfo||[]];if(t.labelsVisible&&r.length&&r.some(a=>"none"===a.deconflictionStrategy))return!0}return!1}("subtype-group"===e.layer.type?e.layer.sublayers.items:[e.layer]),a={};if("subtype-group"!==e.layer.type){if("heatmap"===e.layer.renderer.type)return;const l=function(n){const e="visualVariables"in n&&n.visualVariables;if(!e)return null;for(const t of e)if("size"===t.type)return _n(t);return null}(e.layer.renderer);a[0]=l}const o=e.tileRenderer;(0,v.Wi)(o)||n.push({tileRenderer:o,vvEvaluators:a,deconflictionEnabled:r,geometryType:i})}class wn{run(e,t,i){const r=[];for(const a of e)a.layer.visible&&bn(r,a);this._transformMetrics(r,t),this._runCollision(r,t,i)}_runCollision(e,t,i){const[r,a]=t.state.size,o=new an(r*t.pixelRatio,a*t.pixelRatio);for(const{tileRenderer:l,deconflictionEnabled:h}of e){const d=l.featuresView.attributeView;if(!h)return void Ce(l,(p,u)=>{for(;u.nextId();)d.setLabelMinZoom(u.id,0)});this._prepare(l),this._collideVisible(o,l,i),this._collideInvisible(o,l)}}_isFiltered(e,t,i){const r=t.getFilterFlags(e);return!((!i.hasFilter||r&T.Zd)&&(!i.effect||i.effect.excludedLabelsVisible||r&T.iV))}_prepare(e){const t=e.featuresView.attributeView,i=new Set;Ce(e,(r,a)=>{for(;a.nextId();)if(!i.has(a.id)){if(i.add(a.id),this._isFiltered(a.id,t,e.layerView)){t.setLabelMinZoom(a.id,254);continue}0!==t.getLabelMinZoom(a.id)?t.setLabelMinZoom(a.id,255):t.setLabelMinZoom(a.id,0)}})}_collideVisible(e,t,i){const r=t.featuresView.attributeView,a=new Set;Ce(t,(o,l)=>{for(;l.nextId();)if(!a.has(l.id))if(o.key.level===i){if(0===r.getLabelMinZoom(l.id))switch(e.insertMetrics(l)){case 1:break;case 2:r.setLabelMinZoom(l.id,254),a.add(l.id);break;case 0:r.setLabelMinZoom(l.id,0),a.add(l.id)}}else r.setLabelMinZoom(l.id,254)})}_collideInvisible(e,t){const i=t.featuresView.attributeView,r=new Set;Ce(t,(a,o)=>{for(;o.nextId();)if(!r.has(o.id)&&255===i.getLabelMinZoom(o.id))switch(e.insertMetrics(o)){case 1:break;case 2:i.setLabelMinZoom(o.id,255),r.add(o.id);break;case 0:i.setLabelMinZoom(o.id,0),r.add(o.id)}})}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:r,vvEvaluators:a}of e)Ce(i,(o,l)=>{const h=i.featuresView.attributeView,d=o.transforms.labelMat2d;d[4]=Math.round(d[4]),d[5]=Math.round(d[5]);const p=d[4],u=d[5],m="polyline"===r;for(;l.next();){const g=l.boundsCount,f=l.anchorX,_=l.anchorY;let x=l.size;const w=a[0];if((0,v.pC)(w)){const C=w(h.getVVSize(l.id));x=isNaN(C)||null==C||C===1/0?x:C}const M=l.directionX*(x/2),P=l.directionY*(x/2);for(let C=0;C<g;C++){let H=f,L=l.anchorY;if(m){let E=H+l.boundsX(C)+M,O=L+l.boundsY(C)+P;t.state.rotation?(E=d[0]*E+d[2]*O+d[4],O=d[1]*E+d[3]*O+d[5]):(E+=p,O+=u),l.setBoundsComputedAnchorX(C,Math.floor(E)),l.setBoundsComputedAnchorY(C,Math.floor(O))}else{t.state.rotation?(H=d[0]*f+d[2]*_+d[4],L=d[1]*f+d[3]*_+d[5]):(H+=p,L+=u);const E=H+l.boundsX(C)+M,O=L+l.boundsY(C)+P;l.setBoundsComputedAnchorX(C,E),l.setBoundsComputedAnchorY(C,O)}}}})}}const Cn=fe.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let se=class extends((0,sn.p)(le.Z)){constructor(n){super(n),this._applyVisibilityPassThrottled=(0,nn.P)(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new wn}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(n){this._applyVisibilityPassThrottled(n)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(n){this._set("updateParameters",n),this.updateRequested&&(this.updateRequested=!1,this.update(n))}_applyVisibilityPass(n){try{const e=this.view.featuresTilingScheme.getClosestInfoForScale(n.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,n,e)}catch(e){Cn.error(new F.Z("mapview-labeling","Encountered an error during label decluttering",e))}}};(0,b._)([(0,S.Cb)()],se.prototype,"updateRequested",void 0),(0,b._)([(0,S.Cb)({readOnly:!0})],se.prototype,"updateParameters",void 0),(0,b._)([(0,S.Cb)()],se.prototype,"updating",null),(0,b._)([(0,S.Cb)()],se.prototype,"view",void 0),se=(0,b._)([(0,he.j)("esri.views.2d.layers.labels.LabelManager")],se);var Mn=se,Tn=c(8940),Sn=c(561),Oe=c(51125),Ie=c(27640),$t=c(9214);let Me=class extends le.Z{constructor(n){super(n),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(n){this._handles&&this._handles.forEach(e=>{e.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",n),n&&(n.on("drag",["Shift"],e=>this._handleDrag(e,1),$t.f.INTERNAL),n.on("drag",["Shift","Ctrl"],e=>this._handleDrag(e,-1),$t.f.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(n,e,t,i){this._box.x=n,this._box.y=e,this._box.width=t,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(n,e,t,i,r){const a=this.view,o=a.toMap((0,re.vW)(n+.5*t,e+.5*i));let l=Math.max(t/a.width,i/a.height);-1===r&&(l=1/l),this._destroyOverlay(),this.navigation.end(),a.goTo({center:o,scale:a.scale*l})}_updateBox(n,e,t,i){const r=this._boxShape;r.setAttributeNS(null,"x",""+n),r.setAttributeNS(null,"y",""+e),r.setAttributeNS(null,"width",""+t),r.setAttributeNS(null,"height",""+i),r.setAttributeNS(null,"class","esri-zoom-box__outline")}_updateBackground(n,e,t,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(n,e,t,i,this.view.width,this.view.height))}_createContainer(){const n=document.createElement("div");n.className="esri-zoom-box__container",this.view.root.appendChild(n),this._container=n}_createOverlay(){const n=this.view.width,e=this.view.height,t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttributeNS(null,"d","M 0 0 L "+n+" 0 L "+n+" "+e+" L 0 "+e+" Z"),t.setAttributeNS(null,"class","esri-zoom-box__overlay-background");const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class","esri-zoom-box__overlay"),r.appendChild(t),r.appendChild(i),this._container.appendChild(r),this._backgroundShape=t,this._boxShape=i,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(n,e,t,i,r,a){const o=n+t,l=e+i;return"M 0 0 L "+r+" 0 L "+r+" "+a+" L 0 "+a+" ZM "+n+" "+e+" L "+n+" "+l+" L "+o+" "+l+" L "+o+" "+e+" Z"}_handleDrag(n,e){const t=n.x,i=n.y,r=n.origin.x,a=n.origin.y;let o,l,h,d;switch(t>r?(o=r,h=t-r):(o=t,h=r-t),i>a?(l=a,d=i-a):(l=i,d=a-i),n.action){case"start":this._start();break;case"update":this._update(o,l,h,d);break;case"end":this._end(o,l,h,d,e)}n.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:n,y:e,width:t,height:i}=this._box;this._updateBox(n,e,t,i),this._updateBackground(n,e,t,i),this._rafId=requestAnimationFrame(this._redraw)}};(0,b._)([(0,S.Cb)()],Me.prototype,"navigation",void 0),(0,b._)([(0,S.Cb)()],Me.prototype,"view",null),Me=(0,b._)([(0,he.j)("esri.views.2d.navigation.ZoomBox")],Me);var Pn=Me,Ae=(c(73513),c(6618)),it=c(10127);class q{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}updateDelta(e){this.filteredDelta=this.hasFilteredDelta?(1-this.gain)*this.filteredDelta+this.gain*e:e}}class st{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(ce(i,t)-1)/Math.log(i)}}class Fn extends st{constructor(e,t,i,r,a){super(e,t,i),this.sceneVelocity=r,this.direction=a}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class Rn{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new q(.6),this.screen=[new q(.4),new q(.4)],this.scene=[new q(.6),new q(.6),new q(.6)],this.tmpDirection=(0,it.c)()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){(0,Ae.s)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const r=(0,Ae.l)(this.tmpDirection);return r>0&&(0,Ae.a)(this.tmpDirection,this.tmpDirection,1/r),new Fn(e,t,i,r/this.time.filteredDelta,this.tmpDirection)}}let de=class extends le.Z{constructor(n){super(n),this.animationTime=0,this.momentumEstimator=new Rn(500,6,.92),this.momentum=null,this.tmpMomentum=(0,it.c)(),this.momentumFinished=!1,this.viewpoint=new Oe.Z({targetGeometry:new Ie.Z,scale:0,rotation:0}),this.watch("momentumFinished",e=>{e&&this.navigation.stop()})}begin(n,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this.previousDrag=e}update(n,e){this.addToEstimator(e);let t=e.center.x,i=e.center.y;const r=this.previousDrag;t=r?r.center.x-t:-t,i=r?i-r.center.y:i,n.viewpoint=(0,I.Rx)(this.viewpoint,n.viewpoint,[t||0,i||0]),this.previousDrag=e}end(n,e){this.addToEstimator(e),this.momentum=n.navigation.momentumEnabled?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(n),this.previousDrag=null,this.navigation.end()}addToEstimator(n){const e=n.center.x,t=n.center.y,i=(0,re.s1)(-e,t),r=(0,it.f)(-e,t,0);this.momentumEstimator.add(i,r,.001*n.timestamp)}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(e,t)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*t;if(!this.momentumFinished){const r=this.momentum.valueDelta(this.animationTime,i);(0,Ae.a)(this.tmpMomentum,this.momentum.direction,r),(0,I.Rx)(e,e,this.tmpMomentum),n.constraints.constrainByGeometry(e)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,b._)([(0,S.Cb)()],de.prototype,"momentumFinished",void 0),(0,b._)([(0,S.Cb)()],de.prototype,"viewpoint",void 0),(0,b._)([(0,S.Cb)()],de.prototype,"navigation",void 0),de=(0,b._)([(0,he.j)("esri.views.2d.navigation.actions.Pan")],de);var Dn=de;class Kt{constructor(e=2.5,t=.01,i=.95,r=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=r,this.enabled=!0,this.value=new q(.8),this.time=new q(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,k.uZ)(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new st(e,t,i)}}class zn extends Kt{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){if(this.value.hasLastValue){const i=this.value.lastValue;let r=e-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;e=i+r}super.add(e,t)}}class Bn extends st{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class En extends Kt{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Bn(e,t,i)}}let ue=class extends le.Z{constructor(n){super(n),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new zn(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new En,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Oe.Z({targetGeometry:new Ie.Z,scale:0,rotation:0}),this.watch("_momentumFinished",e=>{e&&this.navigation.stop()})}begin(n,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,n.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(n,e){null===this._updateTimestamp&&(this._updateTimestamp=e.timestamp);const t=e.angle,i=e.radius,r=e.center,a=Math.abs(180*(t-this._startAngle)/Math.PI),o=Math.abs(i-this._startRadius),l=this._startRadius/i;if(this._previousRadius){const h=i/this._previousRadius;let d=180*(t-this._previousAngle)/Math.PI;this._rotationDirection=d>=0?1:-1,this._zoomDirection=h>=1?1:-1,n.constraints.rotationEnabled?(null===this._zoomOnly&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=o-a>0),null===this._zoomOnly||this._zoomOnly?d=0:this.addToRotateEstimator(t-this._startAngle,e.timestamp)):d=0,this.addToZoomEstimator(e,l),this.navigation.setViewpoint([r.x,r.y],1/h,d,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=t,this._previousRadius=i,this._previousCenter=r}end(n){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(n),this.navigation.end()}addToRotateEstimator(n,e){this._rotationMomentumEstimator.add(n,.001*e)}addToZoomEstimator(n,e){this._zoomMomentumEstimator.add(e,.001*n.timestamp)}canZoomIn(n){const t=n.constraints.effectiveMaxScale;return 0===t||n.scale>t}canZoomOut(n){const t=n.constraints.effectiveMinScale;return 0===t||n.scale<t}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(e,t)=>{const i=!this.canZoomIn(n)&&this._zoomDirection>1||!this.canZoomOut(n)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),a=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),o=.001*t;if(this._momentumFinished=r&&a,!this._momentumFinished){const l=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,o))*this._rotationDirection*180/Math.PI:0;let h=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,o)):1;const d=(0,K.a)(),p=(0,K.a)();if(this._previousCenter){(0,D.s)(d,this._previousCenter.x,this._previousCenter.y),(0,I.Dq)(p,n.size,n.padding),(0,D.i)(d,d,p);const{constraints:u,scale:m}=n,g=m*h;h<1&&!u.canZoomInTo(g)?(h=m/u.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):h>1&&!u.canZoomOutTo(g)&&(h=m/u.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,I.UZ)(e,n.viewpoint,h,l,d,n.size),n.constraints.constrainByGeometry(e)}}this._animationTime+=o})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,b._)([(0,S.Cb)()],ue.prototype,"_momentumFinished",void 0),(0,b._)([(0,S.Cb)()],ue.prototype,"viewpoint",void 0),(0,b._)([(0,S.Cb)()],ue.prototype,"navigation",void 0),ue=(0,b._)([(0,he.j)("esri.views.2d.navigation.actions.Pinch")],ue);var On=ue;const nt=(0,K.a)(),Yt=(0,K.a)();let Te=class extends le.Z{constructor(n){super(n),this._previousCenter=(0,K.a)(),this.viewpoint=new Oe.Z({targetGeometry:new Ie.Z,scale:0,rotation:0})}begin(n,e){this.navigation.begin(),(0,D.s)(this._previousCenter,e.center.x,e.center.y)}update(n,e){const{state:{size:t,padding:i}}=n;(0,D.s)(nt,e.center.x,e.center.y),(0,I.ni)(Yt,t,i),n.viewpoint=(0,I.$H)(this.viewpoint,n.state.paddedViewState.viewpoint,(0,I.dI)(Yt,this._previousCenter,nt)),(0,D.c)(this._previousCenter,nt)}end(){this.navigation.end()}};(0,b._)([(0,S.Cb)()],Te.prototype,"viewpoint",void 0),(0,b._)([(0,S.Cb)()],Te.prototype,"navigation",void 0),Te=(0,b._)([(0,he.j)("esri.views.2d.actions.Rotate")],Te);var In=Te;const rt=new Oe.Z({targetGeometry:new Ie.Z}),at=[0,0];let X=class extends le.Z{constructor(n){super(n),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Dn({navigation:this}),this.rotate=new In({navigation:this}),this.pinch=new On({navigation:this}),this.zoomBox=new Pn({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}zoom(n,e=this._getDefaultAnchor()){var t=this;return(0,y.Z)(function*(){if(t.stop(),t.begin(),t.view.constraints.snapToZoom&&t.view.constraints.effectiveLODs)return n<1?t.zoomIn(e):t.zoomOut(e);t.setViewpoint(e,n,0,[0,0])})()}zoomIn(n){var e=this;return(0,y.Z)(function*(){const t=e.view,i=t.constraints.snapToNextScale(t.scale);return e._zoomToScale(i,n)})()}zoomOut(n){var e=this;return(0,y.Z)(function*(){const t=e.view,i=t.constraints.snapToPreviousScale(t.scale);return e._zoomToScale(i,n)})()}setViewpoint(n,e,t,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,n,e,t,i),this.end()}setViewpointImmediate(n,e=0,t=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,n,e,t)}continousRotateClockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,e=>{(0,I.$H)(e,e,-1)})}continousRotateCounterclockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,e=>{(0,I.$H)(e,e,1)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(n){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,t=>{(0,I.Rx)(t,t,n),this.view.constraints.constrainByGeometry(t)})}_startTimer(n){return null!==this._endTimer||(this._endTimer=setTimeout(()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<250?this._endTimer=this._startTimer(e):this._set("interacting",!1)},n)),this._endTimer}_getDefaultAnchor(){const{size:n,padding:{left:e,right:t,top:i,bottom:r}}=this.view;return at[0]=.5*(n[0]-t+e),at[1]=.5*(n[1]-r+i),at}_zoomToScale(n,e=this._getDefaultAnchor()){var t=this;return(0,y.Z)(function*(){const{view:i}=t,{constraints:r,scale:a,viewpoint:o,size:l,padding:h}=i,d=r.canZoomInTo(n),p=r.canZoomOutTo(n);if(!(n<a&&!d||n>a&&!p))return(0,I.gG)(rt,o,n/a,0,e,l,h),r.constrainByGeometry(rt),i.goTo(rt,{animate:!0})})()}_scaleRotateTranslateViewpoint(n,e,t,i,r){const{view:a}=this,{size:o,padding:l,constraints:h,scale:d,viewpoint:p}=a,u=d*t,m=h.canZoomInTo(u),g=h.canZoomOutTo(u);return(t<1&&!m||t>1&&!g)&&(t=1),(0,I.Rx)(p,p,r),(0,I.gG)(n,p,t,i,e,o,l),h.constrainByGeometry(n)}};(0,b._)([(0,S.Cb)()],X.prototype,"animationManager",void 0),(0,b._)([(0,S.Cb)({type:Boolean,readOnly:!0})],X.prototype,"interacting",void 0),(0,b._)([(0,S.Cb)()],X.prototype,"pan",void 0),(0,b._)([(0,S.Cb)()],X.prototype,"pinch",void 0),(0,b._)([(0,S.Cb)()],X.prototype,"rotate",void 0),(0,b._)([(0,S.Cb)()],X.prototype,"view",void 0),(0,b._)([(0,S.Cb)()],X.prototype,"zoomBox",void 0),X=(0,b._)([(0,he.j)("esri.views.2d.navigation.MapViewNavigation")],X);var Un=X,An=c(47765),Ln=c(89225),Vn=c(66505);const Jt={shaders:{vertexShader:(0,A.w)("magnifier/magnifier.vert"),fragmentShader:(0,A.w)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var qt=c(94226);function ot(){return ot=(0,y.Z)(function*(n){const e=c.e(7865).then(c.bind(c,27865)),t=c.e(5768).then(c.bind(c,25768)),i=(0,qt.t)((yield e).default,{signal:n}),r=(0,qt.t)((yield t).default,{signal:n}),a={mask:yield i,overlay:yield r};return(0,z.k_)(n),a}),ot.apply(this,arguments)}class Hn extends Vn.s{constructor(){super(),this._handles=new An.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,lt.S1)(e,"version",()=>{this.visible=e.visible&&(0,v.pC)(e.position)&&e.size>0,this.requestRender()}),e.watch(["mask","overlay"],()=>this._reloadResources()),e.watch("size",()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:(0,ht.c)()}}doRender(e){var t;const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==R.jx.MAP||!this._canRender())return;this._updateResources(e);const r=this._magnifier;if((0,v.Wi)(r.position))return;const a=e.pixelRatio,o=r.size*a,h=Math.ceil(1/r.factor*o);this._readbackTexture.resize(h,h);const{size:d}=e.state,p=a*d[0],u=a*d[1],m=.5*h,g=.5*h,f=(0,k.uZ)(a*r.position.x,m,p-m-1),_=(0,k.uZ)(u-a*r.position.y,g,u-g-1);i.setBlendingEnabled(!0);const x=f-m,w=_-g,M=this._readbackTexture;i.bindTexture(M,0),i.gl.copyTexImage2D(M.descriptor.target,0,M.descriptor.pixelFormat,x,w,h,h,0);const P=null==(t=this.background)?void 0:t.color,C=P?[P.a*P.r/255,P.a*P.g/255,P.a*P.b/255,P.a]:[1,1,1,1],H=(f+r.offset.x*a)/p*2-1,L=(_-r.offset.y*a)/u*2-1,E=o/p*2,O=o/u*2,V=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(V),V.setUniform4fv("u_background",C),V.setUniform1i("u_readbackTexture",0),V.setUniform1i("u_overlayTexture",6),V.setUniform1i("u_maskTexture",7),V.setUniform4f("u_drawPos",H,L,E,O),V.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),V.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const t=(0,v.pC)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,v.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,z.vr)(function(){var r=(0,y.Z)(function*(a){const o=(0,v.Wi)(t)||(0,v.Wi)(i)?function(n){return ot.apply(this,arguments)}(a):null,l=(0,v.pC)(t)?(0,ge.default)(t,{responseType:"image",signal:a}).then(u=>u.data):o.then(u=>u.mask),h=(0,v.pC)(i)?(0,ge.default)(i,{responseType:"image",signal:a}).then(u=>u.data):o.then(u=>u.overlay),[d,p]=yield Promise.all([l,h]);e.mask=d,e.overlay=p,e._disposeRenderResources(),e.requestRender()});return function(a){return r.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,v.O3)(this._readbackTexture),this._overlayTexture=(0,v.O3)(this._overlayTexture),this._maskTexture=(0,v.O3)(this._maskTexture),this._vertexArrayObject=(0,v.O3)(this._vertexArrayObject),this._program=(0,v.O3)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(n){return(0,Z.H)(n,Jt)}(t);const a=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new Pe.Z(t,Jt.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:pe.Z.createVertex(t,35044,a)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new Y.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!(0,Ln.zd)(this.overlay.src)||!e.driverTestResult.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new Y.Z(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const l=1/this._magnifier.factor;this._readbackTexture=new Y.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(l*i),height:Math.ceil(l*i)})}}}}]);